rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isLawyer() {
      return getUserData().role == 'LAWYER' || getUserData().role == 'LAW_FIRM';
    }

    function isClient() {
      return getUserData().role == 'CLIENT';
    }

    function isAdmin() {
      return getUserData().role == 'ADMIN';
    }

    function isVerifiedLawyer() {
      let lawyerProfile = get(/databases/$(database)/documents/lawyerProfiles/$(request.auth.uid)).data;
      return lawyerProfile.verificationStatus == 'VERIFIED';
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();

      // User subcollections
      match /favorites/{favoriteId} {
        allow read, write: if isOwner(userId);
      }

      match /blocked/{blockedId} {
        allow read, write: if isOwner(userId);
      }
    }

    // Client profiles
    match /clientProfiles/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId) || isAdmin();
    }

    // Lawyer profiles
    match /lawyerProfiles/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // Corporate profiles
    match /corporateProfiles/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId) || isAdmin();
    }

    // Cases
    match /cases/{caseId} {
      // Anyone authenticated can read (for lawyers to see available cases)
      allow read: if isAuthenticated();

      // Only clients can create cases
      allow create: if isClient() && request.resource.data.clientId == request.auth.uid;

      // Client who owns the case or assigned lawyer can update
      allow update: if isOwner(resource.data.clientId) ||
                      (resource.data.lawyerId != null && isOwner(resource.data.lawyerId)) ||
                      isAdmin();

      // Only admin can delete
      allow delete: if isAdmin();
    }

    // Case documents (subcollection)
    match /caseDocuments/{docId} {
      allow read: if isAuthenticated() &&
                   (isOwner(resource.data.uploadedBy) ||
                    resource.data.caseId in getUserCases());

      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.uploadedBy);
      allow delete: if isOwner(resource.data.uploadedBy) || isAdmin();
    }

    // Bids
    match /bids/{bidId} {
      // Case owner and bid owner can read
      allow read: if isAuthenticated();

      // Only verified lawyers can create bids
      allow create: if isLawyer() &&
                     request.resource.data.lawyerId == request.auth.uid;

      // Bid owner can update their pending bids, case owner can accept/reject
      allow update: if (isOwner(resource.data.lawyerId) && resource.data.status == 'PENDING') ||
                      getCaseOwner(resource.data.caseId) == request.auth.uid ||
                      isAdmin();

      allow delete: if isAdmin();
    }

    // Escrows
    match /escrows/{escrowId} {
      // Only parties involved can read
      allow read: if isOwner(resource.data.clientId) ||
                   isOwner(resource.data.lawyerId) ||
                   isAdmin();

      // System creates escrows (via Cloud Functions ideally)
      allow create: if isAuthenticated();

      // Parties can update for confirmations
      allow update: if isOwner(resource.data.clientId) ||
                      isOwner(resource.data.lawyerId) ||
                      isAdmin();

      allow delete: if isAdmin();
    }

    // Conversations
    match /conversations/{conversationId} {
      // Only participants can read
      allow read: if isAuthenticated() &&
                   request.auth.uid in resource.data.participantIds;

      // Authenticated users can create conversations
      allow create: if isAuthenticated() &&
                     request.auth.uid in request.resource.data.participantIds;

      // Only participants can update
      allow update: if isAuthenticated() &&
                      request.auth.uid in resource.data.participantIds;

      allow delete: if isAdmin();
    }

    // Messages
    match /messages/{messageId} {
      // Participants of the conversation can read
      allow read: if isAuthenticated();

      // Sender must be authenticated and be the sender
      allow create: if isAuthenticated() &&
                     request.resource.data.senderId == request.auth.uid;

      // Only sender can update (edit/delete)
      allow update: if isOwner(resource.data.senderId);

      allow delete: if isAdmin();
    }

    // Reviews
    match /reviews/{reviewId} {
      // Anyone can read non-reported reviews
      allow read: if isAuthenticated();

      // Only clients who completed a case can create reviews
      allow create: if isClient() &&
                     request.resource.data.clientId == request.auth.uid;

      // Client can update their review, lawyer can add response
      allow update: if isOwner(resource.data.clientId) ||
                      isOwner(resource.data.lawyerId) ||
                      isAdmin();

      allow delete: if isAdmin();
    }

    // Consultations
    match /consultations/{consultationId} {
      allow read: if isOwner(resource.data.clientId) ||
                   isOwner(resource.data.lawyerId) ||
                   isAdmin();

      allow create: if isAuthenticated();

      allow update: if isOwner(resource.data.clientId) ||
                      isOwner(resource.data.lawyerId) ||
                      isAdmin();

      allow delete: if isAdmin();
    }

    // Lawyer availability
    match /lawyerAvailability/{lawyerId} {
      allow read: if isAuthenticated();
      allow create, update: if isOwner(lawyerId);
      allow delete: if isOwner(lawyerId) || isAdmin();
    }

    // Earnings
    match /earnings/{earningId} {
      allow read: if isOwner(resource.data.lawyerId) || isAdmin();
      allow create: if isAdmin(); // Created by system/cloud functions
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Wallets
    match /wallets/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // Payouts
    match /payouts/{payoutId} {
      allow read: if isOwner(resource.data.lawyerId) || isAdmin();
      allow create: if isLawyer() && request.resource.data.lawyerId == request.auth.uid;
      allow update: if isAdmin(); // Only admin can process payouts
      allow delete: if isAdmin();
    }

    // Payment methods
    match /paymentMethods/{methodId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // Transactions
    match /transactions/{transactionId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Notifications
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // User push tokens
    match /userTokens/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Disputes
    match /disputes/{disputeId} {
      allow read: if isOwner(resource.data.clientId) ||
                   isOwner(resource.data.lawyerId) ||
                   isAdmin();

      allow create: if isAuthenticated() &&
                     (request.resource.data.clientId == request.auth.uid ||
                      request.resource.data.lawyerId == request.auth.uid);

      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Payments
    match /payments/{paymentId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Helper function to get case owner (would need Cloud Function for complex queries)
    function getCaseOwner(caseId) {
      return get(/databases/$(database)/documents/cases/$(caseId)).data.clientId;
    }

    // Note: getUserCases would require a more complex implementation
    // Consider using Cloud Functions for complex authorization logic

    // Follows
    match /follows/{followId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.followerId == request.auth.uid;
      allow delete: if isOwner(resource.data.followerId);
    }
  }
}
